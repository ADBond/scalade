(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))a(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function e(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function a(r){if(r.ep)return;r.ep=!0;const s=e(r);fetch(r.href,s)}})();class h{constructor(t,e,a,r){this.name=t,this.trickTakingRank=e,this.score=a,this.ttRankAbove=r}toString(){return this.name}toStringShort(){return this.name[0]}static rankEquals(t,e){return t.name==e.name}}class p{constructor(t,e){this.name=t,this.rankForTrumpPreference=e}toString(){return this.name}toStringShort(){return this.name[0]}static suitEquals(t,e){return t.name==e.name}}class m{constructor(t,e){this.suit=t,this.rank=e}toString(){return`${this.rank.toString()} of ${this.suit.toString()}`}toStringShort(){return`${this.rank.toStringShort()}${this.suit.toStringShort()}`}nextCardUp(t){const e=this.rank.ttRankAbove,a=this.suit,r=t.filter(s=>p.suitEquals(s.suit,a)&&s.rank.trickTakingRank==e);return r.length!=1&&console.log(`Error in nextCardUp: ${r}`),r[0]}static cardEquals(t,e){return h.rankEquals(t.rank,e.rank)&&p.suitEquals(t.suit,e.suit)}}const w=[...Array.from({length:9},(n,t)=>{const e=t+2;return new h(e!==10?String(e):"T",e,e,e+1)}),new h("J",11,12,12),new h("Q",12,15,13),new h("K",13,18,14),new h("A",14,1,4)],I=[new p("Diamonds",0),new p("Hearts",1),new p("Spades",2),new p("Clubs",3)];class y{constructor(t=4){this.minRank=t,this.cards=[],this.cards=this.getFullPack()}getFullPack(){const t=[];for(const e of I)for(const a of w){if(a.trickTakingRank<this.minRank)continue;let r=new m(e,a);a.name=="A"&&(r.rank.ttRankAbove=this.minRank),t.push(r)}return t}getCard(t){for(const e of this.getFullPack())if(e.toStringShort()==t)return e;throw new Error(`Failed to locate card: ${t}`)}static shuffle(t){for(let e=t.length-1;e>0;e--){const a=Math.floor(Math.random()*(e+1));[t[e],t[a]]=[t[a],t[e]]}}isEmpty(){return this.cards.length===0}filterOut(t){return this.cards.filter(a=>!t.some(r=>m.cardEquals(a,r)))}get count(){return this.cards.length}}const x=["player","comp1","comp2"];class b{constructor(t,e,a,r,s){this.displayName=t,this.name=e,this.hand=a}}const E={chooseMove:(n,t)=>{const e=Math.floor(Math.random()*t.length);return t[e]}};class L{constructor(t){this.playerNames=t,this.players=[],this.pack=new y,this.cardsPerHand=12,this.trickInProgress=[],this.penultimateCards=[],this.ladders=this.getStartingLadders(),this.trumpSuit=null,this.currentState="initialiseGame";const e=["player","comp1","comp2"],a=["human",E,E];this.players=t.map((r,s)=>new b(r,e[s],[],0,a[s]));for(const r of t)this.players.push();this.dealerIndex=0,this.currentPlayerIndex=0,this.trickIndex=0,this.trickWinnerPlayerIndex=-1,this.finalTrickWinnerIndex=-1}increment(){switch(this.currentState){case"initialiseGame":this.dealCards(this.pack),this.currentState="playCard";break;case"playCard":break;case"trickComplete":this.resetTrick();break}}get trickInProgressCards(){return this.trickInProgress.map(([t,e])=>t)}getPlayedCard(t){const e=this.trickInProgress.filter(([r,s])=>s.name==t),a=e.length;return a==1?e[0][0]:(a>1&&console.log(`getPlayedCard error: ${e}`),null)}getStartingLadders(){return["5D","6H","7S","8C"].map(t=>[this.pack.getCard(t),null])}get ladderCards(){return this.ladders.map(([t,e])=>t)}trumpSuitFromLadders(){const t=this.ladderCards,e=Math.min(...t.map(i=>i.rank.trickTakingRank)),a=t.filter(i=>i.rank.trickTakingRank==e);if(a.length==1)return a[0].suit;const r=Math.max(...t.map(i=>i.suit.rankForTrumpPreference)),s=t.filter(i=>i.suit.rankForTrumpPreference==r);if(s.length==1)return s[0].suit;throw new Error("Error determining trump suit")}incrementRungCount(t){}updateLadders(t){let e=this.trickInProgressCards;this.isPenultimateTrick&&(e=e.concat(this.penultimateCards));let a;for(;(a=this.ladderCards.filter(r=>e.filter(s=>m.cardEquals(s,r.nextCardUp(this.pack.getFullPack()))))).length>0;){let r=a[0],s=r.nextCardUp(this.pack.getFullPack());this.ladders=this.ladders.filter(([i,o])=>!m.cardEquals(i,r)),this.ladders.push([s,t]),e=e.filter(i=>m.cardEquals(i,s)),e.push(r),this.incrementRungCount(r.suit)}return e}get isPenultimateTrick(){return this.trickIndex==this.cardsPerHand-2}get isFinalTrick(){return this.trickIndex==this.cardsPerHand-1}get handNotFinished(){return this.players.map(t=>t.hand).some(t=>t.length>0)}resetTrick(){const t=this.trickWinnerPlayerIndex;this.currentPlayerIndex=t,this.updateLadders(t),this.isFinalTrick&&(this.finalTrickWinnerIndex=t),this.trickInProgress=[],this.trickIndex++,this.handNotFinished?this.currentState="playCard":this.currentState="handComplete"}dealCards(t,e=12){const a=this.pack.filterOut(this.ladderCards);y.shuffle(a);for(let r=0;r<e;r++)for(let s=0;s<3;s++){const i=a.pop();i&&this.giveCardToPlayer(s,i)}this.trumpSuit=this.trumpSuitFromLadders()}giveCardToPlayer(t,e){this.players[t].hand.push(e)}getPlayerHand(t){return this.players[t].hand??[]}playCard(t,e){const a=this.getPlayerHand(t);if(!a)return!1;const r=a.findIndex(s=>s.rank===e.rank&&s.suit===e.suit);if(r>=0){const[s]=a.splice(r,1);return!0}return!1}getStateForUI(){return{hands:{comp1:[],player:this.getPlayerHand(0),comp2:[]},trumps:this.trumpSuit,played:Object.fromEntries(x.map(t=>[t,this.getPlayedCard(t)])),previous:{comp1:null,player:null,comp2:null},ladder:{comp1:[],player:[],comp2:[],neutral:this.ladders.filter(([t,e])=>e===null).map(([t,e])=>t)},scores:{comp1:0,player:0,comp2:0},scores_previous:{comp1:0,player:0,comp2:0},score_details:{},holding_bonus:{comp1:{},player:{},comp2:{}},dead:[],penultimate:[],escalations:-1,hand_number:-1,advance:"C",game_state:"play_card",whose_turn:"human"}}}class _{constructor(t){this.pack=new y,this.state=new L(t),this.state.increment()}getGameState(){return this.state}getGameStateForUI(){return this.state.getStateForUI()}playCard(t,e){return!0}}const $={2:0,3:1,4:2,5:3,6:4,7:5,8:6,9:7,T:8,J:9,Q:10,K:11,A:12},P={S:0,H:1,C:2,D:3},F=72,H=96;function u(n,t){const e=document.createElement("span");e.className="card";const a=n.match(/^([0-9TJQKA])([SHDC])$/);if(a){const[,r,s]=a,i=$[r],o=P[s];e.style.backgroundPosition=`-${i*F}px -${o*H}px`}else e.innerText=n,e.style.background="#ccc";return t&&(e.onclick=()=>t(n)),e}function g(n){const t=document.createElement("span");t.className="suit-icon";const e=n.match(/^([SHDC])$/),a=32;if(e){const[,r]=e,s=P[r];t.style.backgroundPosition=`32px -${s*a}px`}else t.innerText="",t.style.background="#ccc";return t}function k(n){console.log(n);const t=document.getElementById("player-hand"),e=n.hands.player;e.sort((o,c)=>100*(o.suit.rankForTrumpPreference-c.suit.rankForTrumpPreference)+(o.rank.trickTakingRank-c.rank.trickTakingRank)),t.innerHTML="",e.forEach(o=>{t.appendChild(u(o.toStringShort(),M))}),["player","comp1","comp2"].forEach(o=>{const c=document.getElementById(`played-${o}`);c.innerHTML="";const d=n.played[o];if(d){const l=u(d.toStringShort());l.classList.add("played-card"),c.appendChild(l)}}),["player","comp1","comp2"].forEach(o=>{const c=document.getElementById(`prev-${o}`);c.innerHTML="";const d=n.previous[o];if(d){const l=u(d.toStringShort());l.classList.add("played-card"),c.appendChild(l)}}),["player","comp1","comp2"].forEach(o=>{const c=document.getElementById(`hb-${o}`);c.innerHTML="";const d=n.holding_bonus[o];for(const[l,T]of Object.entries(d))for(let S=0;S<T;S++){const C=g(l);C.classList.add("holding-bonus-icon"),c.appendChild(C)}}),["neutral","player","comp1","comp2"].forEach(o=>{const c=document.getElementById(`ladder-${o}`);c.innerHTML="",n.ladder[o].forEach(d=>{c.appendChild(u(d.toStringShort()))})});const a=document.getElementById("penultimate-display"),r=document.getElementById("dead-display");a.innerHTML="",r.innerHTML="",n.penultimate.forEach(o=>a.appendChild(u(o.toStringShort()))),n.dead.forEach(o=>r.appendChild(u(o.toStringShort()))),document.getElementById("scores").innerText=`You: ${n.scores.player}, comp 1: ${n.scores.comp1}, comp 2: ${n.scores.comp2}`,document.getElementById("scores-previous").innerText=`prev: (You: ${n.scores_previous.player}, comp 1: ${n.scores_previous.comp1}, comp 2: ${n.scores_previous.comp2})`,document.getElementById("escalations").innerText=`Escalations: ${n.escalations} (hand #${n.hand_number})`;const s=document.getElementById("trumps");s.innerHTML="",s.appendChild(g(n.trumps?n.trumps.toStringShort():""));const i=document.getElementById("advance");switch(i.innerHTML="",i.appendChild(g(n.advance)),n.game_state){case"play_card":if(n.whose_turn==="human")break;f(700);break;case"trick_complete":f(1700);break;case"hand_complete":f(3e3);break}}async function f(n){await v(n),A()}function v(n){return new Promise(t=>setTimeout(t,n))}async function R(n){document.getElementById("player-hand").appendChild(u("4D"));const e=n.getGameStateForUI();k(e)}async function M(n){const e=await(await fetch("/play_card",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({card:n})})).json();k(e)}async function A(){const t=await(await fetch("/increment_state",{method:"POST"})).json();k(t)}window.onload=()=>{const n=new _(["Andy","Randy1","Randy2"]);R(n)};
