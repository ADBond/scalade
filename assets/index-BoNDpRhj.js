(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function e(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(r){if(r.ep)return;r.ep=!0;const a=e(r);fetch(r.href,a)}})();class g{constructor(t,e,n,r){this.name=t,this.trickTakingRank=e,this.score=n,this.ttRankAbove=r}toString(){return this.name}toStringShort(){return this.name[0]}static rankEquals(t,e){return t.name===e.name}}class h{constructor(t,e){this.name=t,this.rankForTrumpPreference=e}toString(){return this.name}toStringShort(){return this.name[0]}static suitEquals(t,e){return t.name===e.name}}class u{constructor(t,e,n){this.suit=t,this.rank=e,this.index=n}toString(){return`${this.rank.toString()} of ${this.suit.toString()}`}toStringShort(){return`${this.rank.toStringShort()}${this.suit.toStringShort()}`}nextCardUp(t){const e=this.rank.ttRankAbove,n=this.suit,r=t.filter(a=>h.suitEquals(a.suit,n)&&a.rank.trickTakingRank===e);return r.length!==1&&console.log(`Error in nextCardUp: ${r}`),r[0]}static cardEquals(t,e){return g.rankEquals(t.rank,e.rank)&&h.suitEquals(t.suit,e.suit)}static cardFromIndex(t,e){const n=e.filter(r=>r.index===t);return n.length!==1&&console.log(`Error in cardFromIndex: ${n}`),n[0]}static singleHighestCard(t){const e=Math.max(...t.map(r=>r.rank.trickTakingRank)),n=t.filter(r=>r.rank.trickTakingRank===e);return n.length>1&&console.log(`Too many highest cards: ${n}`),n[0]}}const b=[...Array.from({length:9},(s,t)=>{const e=t+2;return new g(e!==10?String(e):"T",e,e,e+1)}),new g("J",11,12,12),new g("Q",12,15,13),new g("K",13,18,14),new g("A",14,1,4)],T=[new h("Diamonds",0),new h("Hearts",1),new h("Spades",2),new h("Clubs",3)],L=T[0];class P{constructor(t=4){this.minRank=t,this.cards=[],this.cards=this.getFullPack()}getFullPack(){const t=[];let e=0;for(const n of b)if(!(n.trickTakingRank<this.minRank)){n.name==="A"&&(n.ttRankAbove=this.minRank);for(const r of T){let a=new u(r,n,e);t.push(a),e++}}return t}getCard(t){for(const e of this.getFullPack())if(e.toStringShort()===t)return e;throw new Error(`Failed to locate card: ${t}`)}static shuffle(t){for(let e=t.length-1;e>0;e--){const n=Math.floor(Math.random()*(e+1));[t[e],t[n]]=[t[n],t[e]]}}isEmpty(){return this.cards.length===0}filterOut(t){return this.cards.filter(n=>!t.some(r=>u.cardEquals(n,r)))}get count(){return this.cards.length}}const f=["player","comp1","comp2"];class F{constructor(t,e,n,r,a,i){this.displayName=t,this.name=e,this.hand=n,this.score=r,this.agent=a,this.positionIndex=i}}const x={chooseMove:(s,t)=>{const e=Math.floor(Math.random()*t.length);return t[e]}};class H{constructor(t){this.playerNames=t,this.players=[],this.pack=new P,this.cardsPerHand=12,this.trickInProgress=[],this.previousTrick=[],this.penultimateCards=[],this.ladders=this.getStartingLadders(),this.trumpSuit=L,this.currentState="initialiseGame";const e=["player","comp1","comp2"],n=["human",x,x];this.players=t.map((r,a)=>new F(r,e[a],[],0,n[a],a));for(const r of t)this.players.push();this.dealerIndex=0,this.currentPlayerIndex=0,this.trickIndex=0,this.finalTrickWinnerIndex=-1}increment(){switch(this.currentState){case"initialiseGame":this.dealCards(this.pack);break;case"playCard":this.computerMove();break;case"trickComplete":this.resetTrick();break;case"handComplete":this.updateScores(),this.dealerIndex=this.getNextPlayerIndex(this.dealerIndex),this.dealCards(this.pack);break}}get trickInProgressCards(){return this.trickInProgress.map(([t,e])=>t)}get currentLedSuit(){const t=this.trickInProgressCards;return t.length===0?null:t[0].suit}get legalMoveIndices(){let t;const e=this.currentPlayerHand,n=this.currentLedSuit;return n===null?t=e:(t=e.filter(r=>h.suitEquals(r.suit,n)),t.length===0&&(t=e)),t.map(r=>r.index)}getPlayedCard(t,e){const n=e.filter(([a,i])=>i.name===t),r=n.length;return r===1?n[0][0]:(r>1&&console.log(`getPlayedCard error: ${n}`),null)}get currentPlayer(){return this.players[this.currentPlayerIndex]}get currentPlayerHand(){return this.currentPlayer.hand}get numPlayers(){return this.players.length}getNextPlayerIndex(t){return(t+1)%this.numPlayers}get trickWinnerPlayer(){return this.trickInProgress.filter(([n,r])=>u.cardEquals(n,this.winningCard))[0][1]}getStartingLadders(){return["5D","6H","7S","8C"].map(t=>[this.pack.getCard(t),null])}get ladderCards(){return this.ladders.map(([t,e])=>t)}trumpSuitFromLadders(){const t=this.ladderCards,e=Math.min(...t.map(i=>i.rank.trickTakingRank)),n=t.filter(i=>i.rank.trickTakingRank===e);if(n.length===1)return n[0].suit;const r=Math.max(...t.map(i=>i.suit.rankForTrumpPreference)),a=t.filter(i=>i.suit.rankForTrumpPreference===r);if(a.length===1)return a[0].suit;throw new Error("Error determining trump suit")}incrementRungCount(t){}updateLadders(t){let e=this.trickInProgressCards;this.isPenultimateTrick&&(e=e.concat(this.penultimateCards));let n;for(;(n=this.ladderCards.filter(r=>e.filter(a=>u.cardEquals(a,r.nextCardUp(this.pack.getFullPack()))).length>0)).length>0;){let r=n[0],a=r.nextCardUp(this.pack.getFullPack());this.ladders=this.ladders.filter(([i,l])=>!u.cardEquals(i,r)),this.ladders.push([a,t]),e=e.filter(i=>!u.cardEquals(i,a)),e.push(r),this.incrementRungCount(r.suit)}return e}get winningCard(){const t=this.trickInProgress.filter(([n,r])=>h.suitEquals(n.suit,this.trumpSuit));let e;if(t.length>0)e=u.singleHighestCard(t.map(([n,r])=>n));else{const n=this.trickInProgress.filter(([r,a])=>h.suitEquals(r.suit,this.currentLedSuit));e=u.singleHighestCard(n.map(([r,a])=>r))}return e}get isPenultimateTrick(){return this.trickIndex===this.cardsPerHand-2}get isFinalTrick(){return this.trickIndex===this.cardsPerHand-1}get handNotFinished(){return this.players.map(t=>t.hand).some(t=>t.length>0)}computerMove(){const t=this.currentPlayer.agent;if(t==="human")return console.log("Error: trying to move for a human"),-20;const e=this.legalMoveIndices,n=t.chooseMove(this,e),r=u.cardFromIndex(n,this.pack.getFullPack());return this.playCard(r)||console.log("Error playing card"),n}resetTrick(){const t=this.trickWinnerPlayer;this.currentPlayerIndex=t.positionIndex,this.updateLadders(t),this.isFinalTrick&&(this.finalTrickWinnerIndex=t.positionIndex),this.previousTrick=this.trickInProgress,this.trickInProgress=[],this.trickIndex++,this.handNotFinished?this.currentState="playCard":this.currentState="handComplete"}dealCards(t,e=12){const n=this.pack.filterOut(this.ladderCards);P.shuffle(n);for(let r=0;r<e;r++)for(let a=0;a<3;a++){const i=n.pop();i&&this.giveCardToPlayer(a,i)}this.trumpSuit=this.trumpSuitFromLadders(),this.currentState="playCard",this.currentPlayerIndex=this.getNextPlayerIndex(this.dealerIndex)}giveCardToPlayer(t,e){this.players[t].hand.push(e)}getPlayerHand(t){return this.players[t].hand??[]}playCard(t){const e=this.currentPlayer,n=e.hand;if(!n)return console.log("Error: I couldn't find a hand!"),!1;const r=n.findIndex(l=>l.rank===t.rank&&l.suit===t.suit);if(r<0)return!1;const[a]=n.splice(r,1);if(this.trickInProgress.push([a,e]),this.trickInProgress.length===this.numPlayers)return this.currentState="trickComplete",!0;const i=this.getNextPlayerIndex(this.currentPlayerIndex);return this.currentPlayerIndex=i,!0}updateScores(){}getStateForUI(){return{hands:{comp1:[],player:this.getPlayerHand(0),comp2:[]},trumps:this.trumpSuit,played:Object.fromEntries(f.map(t=>[t,this.getPlayedCard(t,this.trickInProgress)])),previous:Object.fromEntries(f.map(t=>[t,this.getPlayedCard(t,this.previousTrick)])),ladder:{...Object.fromEntries(f.map(t=>[t,this.ladders.filter(([e,n])=>n!==null&&n.name===t).map(([e,n])=>e)])),neutral:this.ladders.filter(([t,e])=>e===null).map(([t,e])=>t)},game_state:this.currentState,whose_turn:this.currentPlayer.name,getCard:t=>this.pack.getCard(t),playCard:t=>(this.playCard(t),this.getStateForUI()),increment:()=>(this.increment(),this.getStateForUI()),scores:{comp1:0,player:0,comp2:0},scores_previous:{comp1:0,player:0,comp2:0},score_details:{},holding_bonus:{comp1:{},player:{},comp2:{}},dead:[],penultimate:[],escalations:-1,hand_number:-1,advance:"C"}}}class _{constructor(t){this.pack=new P,this.state=new H(t),this.state.increment()}getGameState(){return this.state}getGameStateForUI(){return this.state.getStateForUI()}}const $={2:0,3:1,4:2,5:3,6:4,7:5,8:6,9:7,T:8,J:9,Q:10,K:11,A:12},w={S:0,H:1,C:2,D:3},M=72,R=96;function m(s,t){const e=document.createElement("span");e.className="card";const n=s.match(/^([0-9TJQKA])([SHDC])$/);if(n){const[,r,a]=n,i=$[r],l=w[a];e.style.backgroundPosition=`-${i*M}px -${l*R}px`}else e.innerText=s,e.style.background="#ccc";return t&&(e.onclick=()=>t()),e}function k(s){const t=document.createElement("span");t.className="suit-icon";const e=s.match(/^([SHDC])$/),n=32;if(e){const[,r]=e,a=w[r];t.style.backgroundPosition=`32px -${a*n}px`}else t.innerText="",t.style.background="#ccc";return t}function q(s,t){const e=s.playCard(t);y(e)}async function y(s){console.log(s);const t=document.getElementById("player-hand"),e=s.hands.player;e.sort((o,c)=>100*(o.suit.rankForTrumpPreference-c.suit.rankForTrumpPreference)+(o.rank.trickTakingRank-c.rank.trickTakingRank)),t.innerHTML="",e.forEach(o=>{t.appendChild(m(o.toStringShort(),s.whose_turn==="player"?()=>q(s,o):void 0))}),["player","comp1","comp2"].forEach(o=>{const c=document.getElementById(`played-${o}`);c.innerHTML="";const d=s.played[o],p=m(d!==null?d.toStringShort():"");p.classList.add("played-card"),c.appendChild(p)}),["player","comp1","comp2"].forEach(o=>{const c=document.getElementById(`prev-${o}`);c.innerHTML="";const d=s.previous[o],p=m(d!==null?d.toStringShort():"");p.classList.add("played-card"),c.appendChild(p)}),["player","comp1","comp2"].forEach(o=>{const c=document.getElementById(`hb-${o}`);c.innerHTML="";const d=s.holding_bonus[o];for(const[p,v]of Object.entries(d))for(let I=0;I<v;I++){const E=k(p);E.classList.add("holding-bonus-icon"),c.appendChild(E)}}),["neutral","player","comp1","comp2"].forEach(o=>{const c=document.getElementById(`ladder-${o}`);c.innerHTML="",s.ladder[o].forEach(d=>{c.appendChild(m(d.toStringShort()))})});const n=document.getElementById("penultimate-display"),r=document.getElementById("dead-display");n.innerHTML="",r.innerHTML="",s.penultimate.forEach(o=>n.appendChild(m(o.toStringShort()))),s.dead.forEach(o=>r.appendChild(m(o.toStringShort()))),document.getElementById("scores").innerText=`You: ${s.scores.player}, comp 1: ${s.scores.comp1}, comp 2: ${s.scores.comp2}`,document.getElementById("scores-previous").innerText=`prev: (You: ${s.scores_previous.player}, comp 1: ${s.scores_previous.comp1}, comp 2: ${s.scores_previous.comp2})`,document.getElementById("escalations").innerText=`Escalations: ${s.escalations} (hand #${s.hand_number})`;const a=document.getElementById("trumps");a.innerHTML="",a.appendChild(k(s.trumps?s.trumps.toStringShort():""));const i=document.getElementById("advance");i.innerHTML="",i.appendChild(k(s.advance));let l;switch(s.game_state){case"playCard":if(s.whose_turn==="player")break;await C(700),l=S(s),y(l);break;case"trickComplete":await C(1700),l=S(s),y(l);break;case"handComplete":await C(3e3),l=S(s),y(l);break;default:console.log(`Error: Switching and failing: ${s.game_state}`)}}function C(s){return new Promise(t=>setTimeout(t,s))}function S(s){return s.increment()}window.onload=()=>{const s=new _(["Andy","Randy1","Randy2"]);y(s.getGameStateForUI())};
